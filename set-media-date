#!/usr/bin/env python3
"""
Set EXIF/metadata dates on images and videos using exiftool.
Handles both image formats (JPEG, PNG) and video formats (MP4, MOV, AVI, etc.)
"""

import subprocess
import sys
import click


def set_media_dates(files, date_string, overwrite=True):
    """
    Set dates on media files using exiftool.
    
    Args:
        files: List of file paths or glob patterns
        date_string: Date in format "YYYY:MM:DD HH:MM:SS" or "YYYY:MM:DD"
        overwrite: If True, don't create backup files
    """
    # Check for AVI files and warn
    avi_files = [f for f in files if f.lower().endswith('.avi')]
    if avi_files:
        click.echo(f"\nWarning: Found {len(avi_files)} AVI file(s). ExifTool cannot write to AVI files.", err=True)
        click.echo("Consider converting to MP4 with ffmpeg:", err=True)
        click.echo(f'  ffmpeg -i "input.avi" -metadata creation_time="{date_string.replace(":", "-", 2).replace(" ", "T")}" -c copy output.mp4\n', err=True)
        
        # Filter out AVI files
        files = [f for f in files if not f.lower().endswith('.avi')]
        if not files:
            click.echo("No processable files remaining after filtering AVI files.", err=True)
            return 1
    
    # Normalize date string - add time if not provided
    if len(date_string.split()) == 1:  # Only date provided
        date_string = f"{date_string} 00:00:00"
    
    # For QuickTime dates, add UTC timezone to avoid offset issues
    qt_date_string = f"{date_string}+00:00"
    
    # Build exiftool command
    cmd = ["exiftool", "-m"]  # -m ignores minor errors
    
    if overwrite:
        cmd.append("-overwrite_original")
    
    # Add all common date tags for both images and videos
    date_tags = [
        # Image tags (use regular date string)
        ("-AllDates", date_string),
        # QuickTime/MP4 tags (need explicit group names and UTC timezone)
        ("-QuickTime:CreateDate", qt_date_string),
        ("-QuickTime:ModifyDate", qt_date_string),
        ("-Track1:TrackCreateDate", qt_date_string),
        ("-Track1:TrackModifyDate", qt_date_string),
        ("-Track1:MediaCreateDate", qt_date_string),
        ("-Track1:MediaModifyDate", qt_date_string),
        ("-Track2:TrackCreateDate", qt_date_string),
        ("-Track2:TrackModifyDate", qt_date_string),
        ("-Track2:MediaCreateDate", qt_date_string),
        ("-Track2:MediaModifyDate", qt_date_string),
        ("-Track3:TrackCreateDate", qt_date_string),
        ("-Track3:TrackModifyDate", qt_date_string),
        ("-Track3:MediaCreateDate", qt_date_string),
        ("-Track3:MediaModifyDate", qt_date_string),
    ]
    
    for tag, value in date_tags:
        cmd.append(f"{tag}={value}")
    
    # Add files
    cmd.extend(files)
    
    click.echo(f"Running: {' '.join(cmd[:10])}... {len(files)} file(s)")
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True)
        click.echo(result.stdout)
        if result.stderr:
            click.echo(result.stderr, err=True)
        return result.returncode
    except FileNotFoundError:
        click.echo("Error: exiftool not found. Please install it first:", err=True)
        click.echo("  Ubuntu/Debian: sudo apt install libimage-exiftool-perl", err=True)
        click.echo("  macOS: brew install exiftool", err=True)
        return 1


@click.command()
@click.argument('date')
@click.argument('files', nargs=-1, required=True)
@click.option(
    '--keep-backup',
    is_flag=True,
    help='Keep _original backup files (default: delete them)'
)
def main(date, files, keep_backup):
    """
    Set dates on images and videos using exiftool.
    
    DATE should be in format "YYYY:MM:DD" or "YYYY:MM:DD HH:MM:SS"
    
    FILES are the media files to process (supports wildcards)
    
    \b
    Examples:
      set-media-date "1960:07:01" *.jpg
      set-media-date "1960:07:01 14:30:00" *.jpg
      set-media-date "2010:01:01" *.mp4
      set-media-date "1960:07:01" *.jpg --keep-backup
      set-media-date "1960:07:01" NODATE_*
    """
    # Validate date format
    date_parts = date.replace(" ", ":").split(":")
    if len(date_parts) not in [3, 6]:
        click.echo("Error: Date must be in format YYYY:MM:DD or YYYY:MM:DD HH:MM:SS", err=True)
        sys.exit(1)
    
    sys.exit(set_media_dates(files, date, overwrite=not keep_backup))


if __name__ == "__main__":
    main()